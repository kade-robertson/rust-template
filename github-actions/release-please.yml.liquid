on:
  push:
    branches:
      - master

env:
  PACKAGE: {{ project-name }}
  {% if sccache -%}
  SCCACHE_GHA_ENABLED: true
  RUSTC_WRAPPER: sccache
  {%- endif %}

{% raw -%}
name: release-please
jobs:
  release-please:
    name: release-please
    runs-on: ubuntu-latest
    outputs:
      did_release: ${{ steps.release.outputs.releases_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@c2a5a2bd6a758a0937f1ddb1e8950609867ed15c # v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
  build-artifacts:
    name: build-artifacts ({%- endraw %}{{project-name}}, {% raw -%}${{ matrix.os }})
    needs: release-please
    if: ${{ needs.release-please.outputs.did_release == 'true' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - id: toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      {%- endraw %}

      {% if sccache -%}
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9
      {%- endif %}

      {% raw -%}
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "16"

      - name: Build
        run: cargo build --release --locked --bin ${{ env.PACKAGE }}

      - name: Move executable
        run: |
          npm install -g move-file-cli mkdirp
          mkdirp artifacts
          if [ "$RUNNER_OS" == "Windows" ]; then
            move-file "target/release/${{ env.PACKAGE }}.exe" "artifacts/${{ env.PACKAGE }}-${{ needs.release-please.outputs.version }}.exe"
          elif [ "$RUNNER_OS" == "Linux" ]; then
            move-file "target/release/${{ env.PACKAGE }}" "artifacts/${{ env.PACKAGE }}-${{ needs.release-please.outputs.version }}-linux"
          else
            move-file "target/release/${{ env.PACKAGE }}" "artifacts/${{ env.PACKAGE }}-${{ needs.release-please.outputs.version }}-mac"
          fi
        shell: bash

      - name: Release
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2
        with:
          files: artifacts/*
          tag_name: ${{ needs.release-please.outputs.tag_name }}
  {%- endraw %}
  {% if docker -%}
  build-docker:
    name: build-docker ({{project-name}}{% raw -%})
    needs: release-please
    if: ${{ needs.release-please.outputs.did_release == 'true' }}
    runs-on: ubuntu-latest
    env:
      REGISTRY: ghcr.io
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Log in to the Container registry
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      {%- endraw %}

      {% if dockerdebian -%}
      {% raw -%}
      - name: Extract metadata for Debian Docker
        id: meta
        uses: docker/metadata-action@c1e51972afc2121e065aed6d45c65596fe445f3f # v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.release-please.outputs.tag_name }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.release-please.outputs.tag_name }}
            type=semver,pattern={{major}},value=${{ needs.release-please.outputs.tag_name }}
            type=ref,event=branch
            type=ref,event=pr
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
      {%- endraw %}
      {%- endif %}

      {% if dockeralpine -%}
      {% raw -%}
      - name: Extract metadata for Alpine Docker
        id: meta-alpine
        uses: docker/metadata-action@c1e51972afc2121e065aed6d45c65596fe445f3f # v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.release-please.outputs.tag_name }}-alpine
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.release-please.outputs.tag_name }}-alpine
            type=semver,pattern={{major}},value=${{ needs.release-please.outputs.tag_name }}-alpine
            type=raw,value=latest-alpine,enable={{is_default_branch}}
      {%- endraw %}
      {%- endif %}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      {% if dockerdebian -%}
      {% raw -%}
      - name: Build and push Debian Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            PACKAGE=${{ env.PACKAGE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      {%- endraw %}
      {%- endif %}

      {% if dockeralpine -%}
      {% raw -%}
      - name: Build and push Alpine Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          file: Dockerfile.alpine
          push: true
          tags: ${{ steps.meta-alpine.outputs.tags }}
          labels: ${{ steps.meta-alpine.outputs.labels }}
          build-args: |
            PACKAGE=${{ env.PACKAGE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      {%- endraw %}
      {%- endif %}
{%- endif %}
